WITH boundaries AS (
SELECT
    ST_LineMerge(ST_Collect(way)) AS way,
    admin_level
  FROM planet_osm_admin
  WHERE way && {{bbox}}
{% if zoom >= 10 %}
    AND admin_level IN (2, 3, 4, 5, 6, 7, 8)
{% elif zoom >= 8 %}
    AND admin_level IN (2, 3, 4, 5, 6)
{% elif zoom >= 6 %}
    AND admin_level IN (2, 3, 4)
{% else %}
    AND admin_level = 2
{% endif %}
  GROUP BY admin_level
)
SELECT
{% if zoom >= 15 %}
    ST_AsMVTGeom(way, {{unbuffered_bbox}}, {{extent}}, {{buffer}}) AS way,
{% else %}
    ST_AsMVTGeom(ST_Simplify(way, {{tile_length}}/512), {{unbuffered_bbox}}, {{extent}}, {{buffer}}) AS way,
{% endif %}
    admin_level
  FROM boundaries
